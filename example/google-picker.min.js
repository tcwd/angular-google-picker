angular.module("lk-google-picker",[]).provider("lkGoogleSettings",function(){this.apiKey=null,this.clientId=null,this.scopes=["https://www.googleapis.com/auth/drive"],this.features=["MULTISELECT_ENABLED"],this.views=["DocsView().setIncludeFolders(true)","DocsUploadView().setIncludeFolders(true)"],this.locale="en",this.$get=["$window",function(e){return{apiKey:this.apiKey,clientId:this.clientId,scopes:this.scopes,features:this.features,views:this.views,locale:this.locale,origin:this.origin||e.location.protocol+"//"+e.location.host}}],this.configure=function(e){for(var i in e)this[i]=e[i]}}).directive("lkGooglePicker",["lkGoogleSettings",function(lkGoogleSettings){return{restrict:"A",scope:{pickerFiles:"=",pickerCallback:"="},link:function(scope,element,attrs){function instantiate(){gapi.load("auth",{callback:onApiAuthLoad}),gapi.load("picker")}function onApiAuthLoad(e){var i={client_id:lkGoogleSettings.clientId,scope:lkGoogleSettings.scopes,user_id:attrs.googleId,authuser:-1};e||(i.immediate=!0),gapi.auth.authorize(i,handleAuthResult)}function handleAuthResult(e){e&&!e.error?(accessToken=e.access_token,openDialog()):"immediate_failed"===e.error?onApiAuthLoad(!0):console.error("handleAuthResult error",e)}function openDialog(){var picker=(new google.picker.PickerBuilder).setLocale(lkGoogleSettings.locale).setOAuthToken(accessToken).setCallback(pickerResponse).setOrigin(lkGoogleSettings.origin);lkGoogleSettings.features.length>0&&angular.forEach(lkGoogleSettings.features,function(e,i){picker.enableFeature(google.picker.Feature[e])}),lkGoogleSettings.views.length>0&&angular.forEach(lkGoogleSettings.views,function(view,key){view=eval("new google.picker."+view),picker.addView(view)});var builtPicker=picker.build();builtPicker||console.error("build picker failed",builtPicker),builtPicker.setVisible(!0)}function pickerResponse(e){e.action==google.picker.Action.PICKED&&(validType(e)?gapi.client.load("drive","v2",function(){angular.forEach(e.docs,function(e,i){scope.pickerFiles.push(e)}),scope.pickerCallback(null,scope.pickerFiles),scope.$apply()}):(scope.pickerCallback(new Error("Invalid type for import.")),scope.$apply()))}var accessToken=null,validType=function(e){if(!e.docs||!e.docs.length)return!1;for(var i=e.docs.length;i--;)if("application/vnd.google-apps.document"!==e.docs[i].mimeType&&"application/vnd.google-apps.kix"!==e.docs[i].mimeType&&"application/vnd.google-apps.presentation"!==e.docs[i].mimeType&&"application/pdf"!==e.docs[i].mimeType)return!1;return!0};gapi.load("auth"),gapi.load("picker"),element.bind("click",function(e){instantiate()})}}}]);